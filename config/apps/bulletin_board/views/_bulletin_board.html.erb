<style>
  /* === Bulletin Board Widget CSS - Matching News Widget Style === */

  /* Header / title / action button */
  .bulletin-widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.25rem;
    font-weight: 600;
    color: #222;
  }

  .bulletin-widget-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .bulletin-widget-action {
    font-size: 1rem;
    padding: 0.2rem 0.8rem;
    border: none;
    background: white;
    border-radius: 999px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .bulletin-widget-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Timestamp line above widget */
  .bulletin-last-updated {
    font-size: 0.75rem;
    color: #666;
    margin-top: -0.5rem;
  }

  /* New post button - styled like announcement action button */
  .bulletin-new-post-btn {
    font-size: 0.85rem;
    background: #f0f9ff;
    border: 1px solid #cce5ff;
    color: #007bff;
    padding: 0.2rem 0.75rem;
    border-radius: 999px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 600;
    transition: background-color 0.2s;
  }

  .bulletin-new-post-btn:hover {
    background-color: #e6f1fd;
  }

  /* Post form styles - matching announcement container */
  .bulletin-form {
    font-family: system-ui, sans-serif;
    color: #111;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafa;
    margin-top: 10px;
    margin-bottom: 10px;
    display: none;
  }

  .bulletin-form.active {
    display: block;
  }

  .bulletin-form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.75rem;
  }

  .bulletin-form-group:last-child {
    margin-bottom: 0;
  }

  .bulletin-form label {
    font-weight: 600;
    font-size: 0.85rem;
    color: #222;
    margin-bottom: 0.4rem;
  }

  .bulletin-form input,
  .bulletin-form textarea {
    padding: 0.6rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    font-size: 0.95rem;
    resize: vertical;
    min-height: 80px;
  }

  .bulletin-form textarea {
    font-family: system-ui, sans-serif;
  }

  .bulletin-form input:focus,
  .bulletin-form textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .bulletin-form-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 0.75rem;
    border-top: 1px solid #ddd;
  }

  .bulletin-btn-submit {
    background: #007bff;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: background-color 0.2s;
  }

  .bulletin-btn-submit:hover {
    background-color: #0056b3;
  }

  .bulletin-btn-cancel {
    background: #e0e0e0;
    color: #333;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: background-color 0.2s;
  }

  .bulletin-btn-cancel:hover {
    background-color: #d0d0d0;
  }

  /* Post container - matching announcement-container style */
  .bulletin-post {
    font-family: system-ui, sans-serif;
    color: #111;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafa;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .bulletin-post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .bulletin-post-author {
    font-weight: 600;
    font-size: 1rem;
    color: #111;
    margin-bottom: 0.25rem;
  }

  .bulletin-post-time {
    font-size: 0.8rem;
    color: #666;
  }

  /* Post body - matching announcement-body style */
  .bulletin-post-body {
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    border-left: 3px solid #007bff;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #222;
    line-height: 1.5;
    background: #fff;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .bulletin-post-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .bulletin-btn-delete {
    background: none;
    border: none;
    color: #d32f2f;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0;
    transition: color 0.2s;
  }

  .bulletin-btn-delete:hover {
    color: #b71c1c;
    text-decoration: underline;
  }

  /* Empty state - matching no-jobs-msg */
  .bulletin-empty {
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    font-size: 0.95rem;
    text-align: center;
    color: #555;
  }

  /* Error message */
  .bulletin-error {
    background: #fdecea;
    border: 1px solid #f5a5a5;
    color: #d32f2f;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
</style>

<div class="bulletin-widget-header">
  <div class="bulletin-widget-title">
    <i class="fas fa-comments"></i>
    <span>Community Bulletin Board</span>
    <!-- New post button next to title -->
    <button id="toggleFormBtn" class="bulletin-new-post-btn">
      <i class="fas fa-plus"></i> New Post
    </button>
  </div>
  <div style="display: flex; gap: 0.5rem; align-items: center;">
    <!-- Refresh button -->
    <button id="reloadBulletin" class="bulletin-widget-action" title="Refresh">
      <i class="fa fa-rotate-right"></i>
    </button>
  </div>
</div>

<!-- Timestamp area -->
<div id="bulletin-timestamp" class="bulletin-last-updated"></div>

<!-- Error message area -->
<div id="bulletin-error"></div>

<!-- Post form (initially hidden) -->
<div id="bulletinForm" class="bulletin-form">
  <div class="bulletin-form-group">
    <label for="postTitle">Subject (optional):</label>
    <input type="text" id="postTitle" placeholder="Enter a subject for your post..." maxlength="200">
  </div>
  <div class="bulletin-form-group">
    <label for="postContent">Message:</label>
    <textarea id="postContent" placeholder="Share your thoughts, questions, or updates..."></textarea>
  </div>
  <div class="bulletin-form-actions">
    <button id="cancelFormBtn" class="bulletin-btn-cancel">Cancel</button>
    <button id="submitPostBtn" class="bulletin-btn-submit">Post</button>
  </div>
</div>

<!-- Posts container -->
<div id="bulletin-posts"></div>

<script>
// Local storage for bulletin board posts (persists in browser)
const STORAGE_KEY = 'mncc_bulletin_posts';

// Get current user from document or environment
function getCurrentUser() {
  // Try to get from OOD user environment
  const userEl = document.querySelector('[data-user]');
  if (userEl) return userEl.getAttribute('data-user');

  // Try to get from OOD common headers
  const userHeader = document.querySelector('meta[name="ood-username"]');
  if (userHeader) return userHeader.getAttribute('content');

  // Default fallback
  return 'Anonymous';
}

// Load posts from local storage
function loadPosts() {
  const stored = localStorage.getItem(STORAGE_KEY);
  return stored ? JSON.parse(stored) : [];
}

// Save posts to local storage
function savePosts(posts) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
}

// Get human-readable relative time
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return "just now";
  if (minutes < 60) return `${minutes} min${minutes !== 1 ? "s" : ""} ago`;
  if (hours < 24) return `${hours} hour${hours !== 1 ? "s" : ""} ago`;
  if (days < 7) return `${days} day${days !== 1 ? "s" : ""} ago`;

  // Show full date if older than a week
  return date.toLocaleDateString();
}

// Update timestamp
function updateBulletinTimestamp() {
  const tsEl = document.getElementById("bulletin-timestamp");
  if (tsEl) {
    const now = new Date();
    tsEl.textContent = `Last refreshed: ${now.toLocaleTimeString()}`;
  }
}

// Render all posts
function renderPosts() {
  const container = document.getElementById('bulletin-posts');
  const posts = loadPosts();

  if (posts.length === 0) {
    container.innerHTML = '<div class="bulletin-empty">No posts yet. Be the first to start a discussion!</div>';
    return;
  }

  // Sort posts by date (newest first)
  posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  container.innerHTML = posts.map((post, index) => `
    <div class="bulletin-post">
      <div class="bulletin-post-header">
        <div>
          <div class="bulletin-post-author">${escapeHtml(post.author)}</div>
          ${post.title ? `<div style="font-weight: 600; color: #333; margin-top: 0.25rem;">${escapeHtml(post.title)}</div>` : ''}
        </div>
        <div class="bulletin-post-time">${timeSince(new Date(post.timestamp))}</div>
      </div>
      <div class="bulletin-post-body">${escapeHtml(post.content)}</div>
      <div class="bulletin-post-actions">
        ${post.author === getCurrentUser() ? `
          <button class="bulletin-btn-delete" onclick="deletePost(${index})">Delete</button>
        ` : ''}
      </div>
    </div>
  `).join('');

  updateBulletinTimestamp();
}

// Delete a post (only by author)
function deletePost(index) {
  if (confirm('Are you sure you want to delete this post?')) {
    const posts = loadPosts();
    posts.splice(index, 1);
    savePosts(posts);
    renderPosts();
  }
}

// Show error message
function showError(message) {
  const errorEl = document.getElementById('bulletin-error');
  errorEl.innerHTML = `<div class="bulletin-error"><i class="fas fa-exclamation-circle"></i> ${escapeHtml(message)}</div>`;
  setTimeout(() => {
    errorEl.innerHTML = '';
  }, 5000);
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Submit new post
function submitPost() {
  const titleEl = document.getElementById('postTitle');
  const contentEl = document.getElementById('postContent');
  const title = titleEl.value.trim();
  const content = contentEl.value.trim();

  if (!content) {
    showError('Please enter a message.');
    return;
  }

  const posts = loadPosts();
  posts.push({
    author: getCurrentUser(),
    title: title,
    content: content,
    timestamp: new Date().toISOString()
  });

  savePosts(posts);

  // Clear form and hide
  titleEl.value = '';
  contentEl.value = '';
  document.getElementById('bulletinForm').classList.remove('active');

  renderPosts();
}

// Toggle form visibility
function toggleForm() {
  const form = document.getElementById('bulletinForm');
  form.classList.toggle('active');

  if (form.classList.contains('active')) {
    document.getElementById('postContent').focus();
  }
}

// Cancel form
function cancelForm() {
  document.getElementById('postTitle').value = '';
  document.getElementById('postContent').value = '';
  document.getElementById('bulletinForm').classList.remove('active');
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  // Render posts on load
  renderPosts();

  // Wire up button events
  document.getElementById('toggleFormBtn')?.addEventListener('click', toggleForm);
  document.getElementById('cancelFormBtn')?.addEventListener('click', cancelForm);
  document.getElementById('submitPostBtn')?.addEventListener('click', submitPost);
  document.getElementById('reloadBulletin')?.addEventListener('click', renderPosts);

  // Submit on Enter in title field (Tab to content)
  // Submit on Ctrl+Enter in content field
  document.getElementById('postContent')?.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      submitPost();
    }
  });
});
</script>
