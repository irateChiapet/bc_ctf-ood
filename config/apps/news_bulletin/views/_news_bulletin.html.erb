<style>
  /* === Combined News & Bulletin Board Layout === */
  .news-bulletin-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    width: 100%;
  }

  .news-bulletin-column {
    display: flex;
    flex-direction: column;
  }

  /* Responsive design for smaller screens */
  @media (max-width: 1200px) {
    .news-bulletin-wrapper {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }

  /* === Announcement widget minimal CSS === */

  /* Header / title / action button */
  .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.25rem;
    font-weight: 600;
    color: #222;
  }
  .widget-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .widget-action {
    font-size: 1rem;
    padding: 0.2rem 0.8rem;
    border: none;
    background: white;
    border-radius: 999px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  /* "View all" link/button */
  .announcement-viewall {
    font-size: 0.75rem;
    background: #f0f9ff;
    border: 1px solid #cce5ff;
    color: #007bff;
    padding: 0.2rem 0.75rem;
    border-radius: 999px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  /* Timestamp line above widget */
  .last-updated {
    font-size: 0.75rem;
    color: #666;
    margin-top: -0.5rem;
  }

  /* Announcement card container */
  .announcement-container {
    font-family: system-ui, sans-serif;
    color: #111;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafa;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  /* Title / topic */
  .announcement-topic {
    font-weight: 600;
    font-size: 1rem;
    color: #111;
    margin-bottom: 0.25rem;
  }
  .announcement-link {
    color: #000;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
  }
  .announcement-link:hover {
    text-decoration: underline;
  }

  /* Metadata row: badge + time */
  .announcement-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.85rem;
    color: #555;
    margin-bottom: 0.5rem;
  }

  /* Badge variants */
  .announcement-badge {
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 999px;
    display: inline-block;
  }
  .announcement-badge.info {
    background-color: #e6f1fd;
    color: #007bff;
  }
  .announcement-badge.alert {
    background-color: #fdecea;
    color: #d32f2f;
  }
  .announcement-badge.maintenance {
    background-color: #fff4e5;
    color: #ff9800;
  }

  /* Relative time text */
  .announcement-time {
    font-size: 0.8rem;
    color: #666;
  }

  /* Body content with contextual border */
  .announcement-body {
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    border-left: 3px solid #007bff;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #222;
    line-height: 1.5;
    background: #fff;
  }
  .announcement-body.alert {
    border-left-color: #d32f2f;
  }
  .announcement-body.maintenance {
    border-left-color: #ff9800;
  }

  /* Fallback / empty state */
  .no-jobs-msg {
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    font-size: 0.95rem;
    text-align: center;
    color: #555;
  }

  /* === Bulletin Board Widget CSS - Matching News Widget Style === */

  /* Header / title / action button */
  .bulletin-widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.25rem;
    font-weight: 600;
    color: #222;
  }

  .bulletin-widget-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .bulletin-widget-action {
    font-size: 1rem;
    padding: 0.2rem 0.8rem;
    border: none;
    background: white;
    border-radius: 999px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .bulletin-widget-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Timestamp line above widget */
  .bulletin-last-updated {
    font-size: 0.75rem;
    color: #666;
    margin-top: -0.5rem;
  }

  /* New post button - styled like announcement action button */
  .bulletin-new-post-btn {
    font-size: 0.85rem;
    background: #f0f9ff;
    border: 1px solid #cce5ff;
    color: #007bff;
    padding: 0.2rem 0.75rem;
    border-radius: 999px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 600;
    transition: background-color 0.2s;
  }

  .bulletin-new-post-btn:hover {
    background-color: #e6f1fd;
  }

  /* Post form styles - matching announcement container */
  .bulletin-form {
    font-family: system-ui, sans-serif;
    color: #111;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafa;
    margin-top: 10px;
    margin-bottom: 10px;
    display: none;
  }

  .bulletin-form.active {
    display: block;
  }

  .bulletin-form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.75rem;
  }

  .bulletin-form-group:last-child {
    margin-bottom: 0;
  }

  .bulletin-form label {
    font-weight: 600;
    font-size: 0.85rem;
    color: #222;
    margin-bottom: 0.4rem;
  }

  .bulletin-form input,
  .bulletin-form textarea {
    padding: 0.6rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    font-size: 0.95rem;
    resize: vertical;
    min-height: 80px;
  }

  .bulletin-form textarea {
    font-family: system-ui, sans-serif;
  }

  .bulletin-form input:focus,
  .bulletin-form textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .bulletin-form-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 0.75rem;
    border-top: 1px solid #ddd;
  }

  .bulletin-btn-submit {
    background: #007bff;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: background-color 0.2s;
  }

  .bulletin-btn-submit:hover {
    background-color: #0056b3;
  }

  .bulletin-btn-cancel {
    background: #e0e0e0;
    color: #333;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: background-color 0.2s;
  }

  .bulletin-btn-cancel:hover {
    background-color: #d0d0d0;
  }

  /* Post container - matching announcement-container style */
  .bulletin-post {
    font-family: system-ui, sans-serif;
    color: #111;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafa;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .bulletin-post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .bulletin-post-author {
    font-weight: 600;
    font-size: 1rem;
    color: #111;
    margin-bottom: 0.25rem;
  }

  .bulletin-post-time {
    font-size: 0.8rem;
    color: #666;
  }

  /* Post body - matching announcement-body style */
  .bulletin-post-body {
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    border-left: 3px solid #007bff;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #222;
    line-height: 1.5;
    background: #fff;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .bulletin-post-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .bulletin-btn-delete {
    background: none;
    border: none;
    color: #d32f2f;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0;
    transition: color 0.2s;
  }

  .bulletin-btn-delete:hover {
    color: #b71c1c;
    text-decoration: underline;
  }

  /* Empty state - matching no-jobs-msg */
  .bulletin-empty {
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    font-size: 0.95rem;
    text-align: center;
    color: #555;
  }

  /* Error message */
  .bulletin-error {
    background: #fdecea;
    border: 1px solid #f5a5a5;
    color: #d32f2f;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
</style>

<div class="news-bulletin-wrapper">
  <!-- Left column: News/Announcements -->
  <div class="news-bulletin-column">
    <div class="widget-header">
      <div class="widget-title">
        <!-- Icon + title for the announcements widget -->
        <i class="fas fa-bullhorn"></i>
        <span>Announcements</span>
        <!-- "View All" link: links to internal announcements -->
        <a class="announcement-viewall" href="#" onclick="showAllPosts(event)">
          <i class="fas fa-newspaper"></i> View All
        </a>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <!-- Manual refresh control -->
        <button id="reloadNews" class="widget-action" title="Refresh">
          <i class="fa fa-rotate-right"></i>
        </button>
      </div>
    </div>
    <!-- Timestamp area; shows last-fetched time -->
    <div id="news-timestamp" class="last-updated"></div>
    <!-- Container where the parsed announcement will be injected -->
    <div id="news-widget"></div>
  </div>

  <!-- Right column: Bulletin Board -->
  <div class="news-bulletin-column">
    <div class="bulletin-widget-header">
      <div class="bulletin-widget-title">
        <i class="fas fa-comments"></i>
        <span>Community Bulletin Board</span>
        <!-- New post button next to title -->
        <button id="toggleFormBtn" class="bulletin-new-post-btn">
          <i class="fas fa-plus"></i> New Post
        </button>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <!-- Refresh button -->
        <button id="reloadBulletin" class="bulletin-widget-action" title="Refresh">
          <i class="fa fa-rotate-right"></i>
        </button>
      </div>
    </div>

    <!-- Timestamp area -->
    <div id="bulletin-timestamp" class="bulletin-last-updated"></div>

    <!-- Error message area -->
    <div id="bulletin-error"></div>

    <!-- Post form (initially hidden) -->
    <div id="bulletinForm" class="bulletin-form">
      <div class="bulletin-form-group">
        <label for="postTitle">Subject (optional):</label>
        <input type="text" id="postTitle" placeholder="Enter a subject for your post..." maxlength="200">
      </div>
      <div class="bulletin-form-group">
        <label for="postContent">Message:</label>
        <textarea id="postContent" placeholder="Share your thoughts, questions, or updates..."></textarea>
      </div>
      <div class="bulletin-form-actions">
        <button id="cancelFormBtn" class="bulletin-btn-cancel">Cancel</button>
        <button id="submitPostBtn" class="bulletin-btn-submit">Post</button>
      </div>
    </div>

    <!-- Posts container -->
    <div id="bulletin-posts"></div>
  </div>
</div>

<script>
// ========== NEWS WIDGET JAVASCRIPT ==========

// Utility: extract HTML between two heading boundaries. Stops early if an unexpected <h2> appears.
function extractTextBetweenElements(startElement, endElement) {
  let content = [];
  let current = startElement.nextElementSibling;
  while (current && current !== endElement && current.tagName !== 'H2') {
    content.push(current.outerHTML);
    current = current.nextElementSibling;
  }
  return content.join('');
}

// Compute human-readable relative time from a Date object.
// This is used to show how old the announcement is.
function timeSinceNews(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  const months = Math.floor(days / 30);
  const years = Math.floor(days / 365);

  if (seconds < 60) return "just now";
  if (minutes < 60) return `Updated ${minutes} min${minutes !== 1 ? "s" : ""} ago`;
  if (hours < 24) return `Updated ${hours} hour${hours !== 1 ? "s" : ""} ago`;
  if (days < 30) return `Updated ${days} day${days !== 1 ? "s" : ""} ago`;
  if (months < 12) return `Updated ${months} month${months !== 1 ? "s" : ""} ago`;
  return `Updated ${years} year${years !== 1 ? "s" : ""} ago`;
}

// Update the small "Last updated:" line above the widget.
function updateNewsTimestamp() {
  const tsEl = document.getElementById("news-timestamp");
  if (tsEl) {
    const now = new Date();
    tsEl.textContent = `Last updated: ${now.toLocaleTimeString()}`;
  }
}

// Local news posts about MNCC security incident
const localNewsPosts = [
  {
    title: "Critical Security Incident at MNCC - Immediate Action Required",
    type: "alert",
    date: new Date(2025, 10, 10), // Nov 10, 2025
    content: `
      <p><strong>CRITICAL SECURITY ALERT:</strong> The Meridian National Computing Center (MNCC) has detected unauthorized access to several compute nodes. An active security incident is currently being investigated.</p>
      <p><strong>Affected Systems:</strong> Compute clusters 1-4, Login nodes 1-2, and select storage systems.</p>
      <p><strong>Immediate Actions:</strong></p>
      <ul>
        <li>All non-essential services have been suspended</li>
        <li>Firewall rules have been tightened</li>
        <li>Security team is conducting forensic analysis</li>
        <li>User sessions will be forcibly terminated for security review</li>
      </ul>
      <p><strong>What You Should Do:</strong> Change your MNCC password immediately. Do not access the system until further notice.</p>
    `
  },
  {
    title: "Security Incident Investigation Update",
    type: "alert",
    date: new Date(2025, 10, 11), // Nov 11, 2025
    content: `
      <p>The MNCC security team has completed initial forensic analysis of the incident reported on November 10th.</p>
      <p><strong>Findings:</strong></p>
      <ul>
        <li>Unauthorized access occurred between 02:00-06:30 UTC</li>
        <li>Attackers exploited a previously patched vulnerability in SSH daemon</li>
        <li>Approximately 47 user accounts were compromised</li>
        <li>No evidence of data exfiltration at this time (investigation ongoing)</li>
      </ul>
      <p><strong>Remediation Steps:</strong></p>
      <ul>
        <li>All SSH services have been patched and restarted</li>
        <li>Compromised accounts have been locked</li>
        <li>Additional monitoring has been deployed</li>
      </ul>
      <p>Status updates will be posted regularly. Check back soon.</p>
    `
  }
];

// Core loader: renders local announcement posts
function loadFirstNewsItem() {
  const widget = document.getElementById('news-widget');
  const refreshBtn = document.getElementById("reloadNews");
  widget.innerHTML = '';
  refreshBtn.disabled = true;

  try {
    // Load the most recent post
    if (localNewsPosts.length > 0) {
      const post = localNewsPosts[0];
      const container = document.createElement('div');
      container.className = 'announcement-container';

      // Build inner HTML from local post
      container.innerHTML = `
        <div class="announcement-topic">
          <a class="announcement-link" href="#">${post.title}</a>
        </div>
        <div class="announcement-meta">
          <span class="announcement-badge ${post.type}">${post.type.charAt(0).toUpperCase() + post.type.slice(1)}</span>
          <span class="announcement-time">${timeSinceNews(post.date)}</span>
        </div>
        <div class="announcement-body ${post.type}">
          ${post.content}
        </div>
      `;

      widget.appendChild(container);
    } else {
      // Fallback if no posts available
      widget.innerHTML = `<div class="no-jobs-msg">No announcements at this time.</div>`;
    }
  } catch (error) {
    // Log for debugging and show an error message to the user
    console.error('Error loading announcements:', error);
    widget.innerHTML = `<div class="no-jobs-msg">Unable to load announcements.</div>`;
  } finally {
    updateNewsTimestamp();
    refreshBtn.disabled = false;
  }
}

// Display all posts instead of just the first one
function showAllPosts(event) {
  event.preventDefault();
  const widget = document.getElementById('news-widget');
  widget.innerHTML = '';

  if (localNewsPosts.length > 0) {
    localNewsPosts.forEach(post => {
      const container = document.createElement('div');
      container.className = 'announcement-container';

      container.innerHTML = `
        <div class="announcement-topic">
          <a class="announcement-link" href="#">${post.title}</a>
        </div>
        <div class="announcement-meta">
          <span class="announcement-badge ${post.type}">${post.type.charAt(0).toUpperCase() + post.type.slice(1)}</span>
          <span class="announcement-time">${timeSinceNews(post.date)}</span>
        </div>
        <div class="announcement-body ${post.type}">
          ${post.content}
        </div>
      `;

      widget.appendChild(container);
    });
  } else {
    widget.innerHTML = `<div class="no-jobs-msg">No announcements available.</div>`;
  }
}

// ========== BULLETIN BOARD JAVASCRIPT ==========

// Server-side secure storage using IndexedDB as fallback to localStorage
// For widget environment, we'll use a hybrid approach with server-side persistence

const STORAGE_KEY = 'mncc_bulletin_widget_posts';
let currentBulletinUser = 'Anonymous';

// Get current user from OOD environment
function getCurrentBulletinUser() {
  // Try to extract from page (OOD sets this in window)
  if (window.ood_user) return window.ood_user;

  // Try from meta tags
  const metaUser = document.querySelector('meta[name="ood-username"]');
  if (metaUser) return metaUser.getAttribute('content');

  // Try from body data attributes (OOD dashboard sets this)
  if (document.body.dataset.user) return document.body.dataset.user;

  // Check window object for user info
  if (window.user) return window.user;

  return 'Anonymous';
}

// Load posts from IndexedDB (persistent, more secure than localStorage)
async function loadBulletinPosts() {
  return new Promise((resolve) => {
    const request = indexedDB.open('mncc_bulletin', 1);

    request.onerror = () => {
      // Fallback to localStorage if IndexedDB fails
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        resolve(stored ? JSON.parse(stored) : []);
      } catch (e) {
        resolve([]);
      }
    };

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('posts')) {
        db.createObjectStore('posts', { keyPath: 'id' });
      }
    };

    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction(['posts'], 'readonly');
      const store = transaction.objectStore('posts');
      const getAllRequest = store.getAll();

      getAllRequest.onsuccess = () => {
        resolve(getAllRequest.result);
      };

      getAllRequest.onerror = () => {
        resolve([]);
      };
    };
  });
}

// Save post to IndexedDB
async function saveBulletinPost(title, content) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('mncc_bulletin', 1);

    request.onerror = () => reject(new Error('Failed to open database'));

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('posts')) {
        db.createObjectStore('posts', { keyPath: 'id' });
      }
    };

    request.onsuccess = (event) => {
      const db = event.target.result;
      const post = {
        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        author: currentBulletinUser,
        title: title,
        content: content,
        timestamp: Math.floor(Date.now() / 1000)
      };

      const transaction = db.transaction(['posts'], 'readwrite');
      const store = transaction.objectStore('posts');
      const addRequest = store.add(post);

      addRequest.onsuccess = () => {
        resolve(post);
      };

      addRequest.onerror = () => {
        reject(new Error('Failed to save post'));
      };
    };
  });
}

// Delete post from IndexedDB
async function deleteBulletinPostViaAPI(postId) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('mncc_bulletin', 1);

    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction(['posts'], 'readwrite');
      const store = transaction.objectStore('posts');
      const deleteRequest = store.delete(postId);

      deleteRequest.onsuccess = () => {
        resolve({ message: 'Post deleted successfully' });
      };

      deleteRequest.onerror = () => {
        reject(new Error('Failed to delete post'));
      };
    };

    request.onerror = () => {
      reject(new Error('Failed to open database'));
    };
  });
}

// Get human-readable relative time
function timeSinceBulletin(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return "just now";
  if (minutes < 60) return `${minutes} min${minutes !== 1 ? "s" : ""} ago`;
  if (hours < 24) return `${hours} hour${hours !== 1 ? "s" : ""} ago`;
  if (days < 7) return `${days} day${days !== 1 ? "s" : ""} ago`;

  // Show full date if older than a week
  return date.toLocaleDateString();
}

// Update timestamp
function updateBulletinTimestamp() {
  const tsEl = document.getElementById("bulletin-timestamp");
  if (tsEl) {
    const now = new Date();
    tsEl.textContent = `Last refreshed: ${now.toLocaleTimeString()}`;
  }
}

// Render all posts
async function renderBulletinPosts() {
  const container = document.getElementById('bulletin-posts');
  container.innerHTML = '<div style="text-align: center; color: #666;">Loading...</div>';

  try {
    const posts = await loadBulletinPosts();

    if (posts.length === 0) {
      container.innerHTML = '<div class="bulletin-empty">No posts yet. Be the first to start a discussion!</div>';
      updateBulletinTimestamp();
      return;
    }

    // Sort posts by timestamp (newest first)
    posts.sort((a, b) => b.timestamp - a.timestamp);

    container.innerHTML = posts.map((post) => `
      <div class="bulletin-post">
        <div class="bulletin-post-header">
          <div>
            <div class="bulletin-post-author">${escapeHtmlBulletin(post.author)}</div>
            ${post.title ? `<div style="font-weight: 600; color: #333; margin-top: 0.25rem;">${escapeHtmlBulletin(post.title)}</div>` : ''}
          </div>
          <div class="bulletin-post-time">${formatBulletinTime(post.timestamp)}</div>
        </div>
        <div class="bulletin-post-body">${escapeHtmlBulletin(post.content)}</div>
        <div class="bulletin-post-actions">
          ${post.author === currentBulletinUser ? `
            <button class="bulletin-btn-delete" onclick="deleteBulletinPost('${post.id}')">Delete</button>
          ` : ''}
        </div>
      </div>
    `).join('');

    updateBulletinTimestamp();
  } catch (error) {
    console.error('Error rendering posts:', error);
    container.innerHTML = '<div class="bulletin-empty">Error loading posts. Please refresh.</div>';
  }
}

// Delete a post (only by author)
async function deleteBulletinPost(postId) {
  if (!confirm('Are you sure you want to delete this post?')) return;

  try {
    await deleteBulletinPostViaAPI(postId);
    await renderBulletinPosts();
  } catch (error) {
    showBulletinError(error.message);
  }
}

// Format timestamp (Unix timestamp in seconds)
function formatBulletinTime(timestamp) {
  const date = new Date(timestamp * 1000);
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);

  if (diff < 60) return 'just now';
  if (diff < 3600) return `${Math.floor(diff / 60)} min${Math.floor(diff / 60) !== 1 ? 's' : ''} ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)} hour${Math.floor(diff / 3600) !== 1 ? 's' : ''} ago`;
  if (diff < 604800) return `${Math.floor(diff / 86400)} day${Math.floor(diff / 86400) !== 1 ? 's' : ''} ago`;

  return date.toLocaleDateString();
}

// Show error message
function showBulletinError(message) {
  const errorEl = document.getElementById('bulletin-error');
  errorEl.innerHTML = `<div class="bulletin-error"><i class="fas fa-exclamation-circle"></i> ${escapeHtmlBulletin(message)}</div>`;
  setTimeout(() => {
    errorEl.innerHTML = '';
  }, 5000);
}

// Escape HTML to prevent XSS
function escapeHtmlBulletin(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Submit new post
async function submitBulletinPost() {
  const titleEl = document.getElementById('postTitle');
  const contentEl = document.getElementById('postContent');
  const title = titleEl.value.trim();
  const content = contentEl.value.trim();

  if (!content) {
    showBulletinError('Please enter a message.');
    return;
  }

  try {
    await saveBulletinPost(title, content);

    // Clear form and hide
    titleEl.value = '';
    contentEl.value = '';
    document.getElementById('bulletinForm').classList.remove('active');

    // Reload posts
    await renderBulletinPosts();
  } catch (error) {
    showBulletinError(error.message);
  }
}

// Toggle form visibility
function toggleBulletinForm() {
  const form = document.getElementById('bulletinForm');
  form.classList.toggle('active');

  if (form.classList.contains('active')) {
    document.getElementById('postContent').focus();
  }
}

// Cancel form
function cancelBulletinForm() {
  document.getElementById('postTitle').value = '';
  document.getElementById('postContent').value = '';
  document.getElementById('bulletinForm').classList.remove('active');
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', async () => {
  // Load news
  loadFirstNewsItem();
  document.getElementById("reloadNews")?.addEventListener("click", loadFirstNewsItem);

  // Get current user and load bulletin board
  currentBulletinUser = getCurrentBulletinUser();
  await renderBulletinPosts();

  // Wire up bulletin board button events
  document.getElementById('toggleFormBtn')?.addEventListener('click', toggleBulletinForm);
  document.getElementById('cancelFormBtn')?.addEventListener('click', cancelBulletinForm);
  document.getElementById('submitPostBtn')?.addEventListener('click', submitBulletinPost);
  document.getElementById('reloadBulletin')?.addEventListener('click', renderBulletinPosts);

  // Submit on Ctrl+Enter in content field
  document.getElementById('postContent')?.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      submitBulletinPost();
    }
  });
});
</script>
